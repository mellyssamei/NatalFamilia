<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Desejos - Natal da Fam√≠lia (Online)</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <style>
        body { background-color: #f8f9fa; font-family: 'Arial', sans-serif; }
        .container { max-width: 700px; padding-top: 20px; padding-bottom: 20px; }
        .header-section { background-color: #dc3545; color: white; border-radius: 10px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        .name-list-item { cursor: pointer; padding: 12px 15px; margin-bottom: 8px; border-radius: 5px; transition: background-color 0.3s; border: 1px solid #dee2e6; }
        .name-list-item:hover { background-color: #e9ecef; }
        .has-list { background-color: #d4edda; border-color: #c3e6cb; }
        .presente-card { border: 1px solid #dc3545; border-left: 5px solid #dc3545; margin-bottom: 15px; padding: 15px; border-radius: 5px; background-color: #fff; }
        .presente-card strong { color: #dc3545; }
        #cadastro-form-area { display: none; padding: 20px; border: 2px dashed #007bff; border-radius: 10px; margin-bottom: 30px; background-color: #eaf4ff; }
        .pre-wrap { white-space: pre-wrap; }
        /* Estilo para loading */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.8); z-index: 1050;
            display: flex; justify-content: center; align-items: center;
            font-size: 1.2rem;
            flex-direction: column;
        }
    </style>
</head>
<body>
    
    <div id="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-3">Carregando listas da fam√≠lia...</p>
    </div>

    <div class="container">
        
        <div class="header-section text-center">
            <h2>üéÑ Natal da Fam√≠lia üéÅ</h2>
            <p class="mb-2">Sorteio de Presentes - Lista de Desejos</p>
            
            <button class="btn btn-warning btn-lg w-100" id="btn-toggle-cadastro">
                Cadastrar / Editar Minha Lista
            </button>
        </div>
        
        <div id="cadastro-form-area">
            <h4 class="text-primary mb-3">Preencha sua Lista de Desejos:</h4>
            
            <form id="presente-form">
                
                <div class="mb-4">
                    <label for="nomeSelect" class="form-label">Eu sou:</label>
                    <select class="form-select" id="nomeSelect" required>
                        <option value="" disabled selected>Selecione seu nome para cadastrar/editar</option>
                    </select>
                </div>
                
                <h5 class="text-secondary mb-3">Sugest√µes de Presente:</h5>
                <div id="presentes-container">
                    </div>
                
                <button type="button" class="btn btn-sm btn-outline-secondary mb-3" id="add-presente-btn">+ Adicionar Outra Op√ß√£o</button>
                
                <div class="d-grid">
                    <button type="submit" class="btn btn-primary btn-lg">Salvar Minha Lista</button>
                </div>
            </form>
        </div>

        <h3 class="mt-4 mb-3 text-center text-primary">Clique no nome para ver a lista de presentes:</h3>
        <div id="main-list" class="list-group">
            </div>

    </div>

    <div class="modal fade" id="presentesModal" tabindex="-1" aria-labelledby="presentesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="presentesModalLabel"></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>üéÅ Sugest√µes de Presente:</h6>
                    <div id="modal-presentes">
                        </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // *** üö® ATEN√á√ÉO: COLOQUE SEU ENDPOINT DA SHEETDB AQUI! üö® ***
        const SHEETDB_API_URL = 'https://sheetdb.io/api/v1/rsadd84wtw4hg'; 
        // ************************************************************

        const NOMES_UNSORTED = [
            "Landia", "B√°rbara", "Suni", "Mica", "Cadu", 
            "Paula", "Andressa", "Ana Clara", "Mateus", "Yasmin", 
            "Max", "Pedro Andressa", "Ana Luiza", "Gilvania", "Gelson", 
            "Lena", "Iris", "Ronaldo", "Sofia", "Mel", 
            "Messias", "Gabriel", "Gleissi", "Dalton", "Nicolas", 
            "Marconi", "Grazi", "Sarah", "Thonny"
        ];
        
        const NOMES = NOMES_UNSORTED.sort((a, b) => a.localeCompare(b));

        let dadosPresentes = {};
        let presenteCount = 0; 
        const MAX_PRESENTES = 5; // Limite de 5 sugest√µes para simplificar as colunas do Sheets

        // --- Fun√ß√µes de API (SheetDB) ---
        
        function showLoading(msg = 'Carregando...') {
            document.getElementById('loading-overlay').style.display = 'flex';
            document.querySelector('#loading-overlay p').textContent = msg;
        }

        function hideLoading() {
            document.getElementById('loading-overlay').style.display = 'none';
        }

        async function loadData() {
            if (SHEETDB_API_URL.includes('COLE_AQUI_O_SEU_ENDPOINT')) {
                alert('ERRO: Por favor, configure o SHEETDB_API_URL no JavaScript com seu link da planilha.');
                hideLoading();
                return;
            }

            showLoading('Carregando listas da fam√≠lia...');
            try {
                const response = await fetch(SHEETDB_API_URL);
                if (!response.ok) throw new Error('Erro ao carregar dados da API.');
                
                const rawData = await response.json();
                
                // Transforma a lista de Planilhas (Sheets) em um Objeto de JS mais f√°cil de usar
                dadosPresentes = rawData.reduce((acc, row) => {
                    // O campo chave no SheetDB √© o primeiro: 'Nome'
                    const nome = row.Nome;
                    if (!nome || !NOMES.includes(nome)) return acc;

                    let presentes = [];
                    for (let i = 1; i <= MAX_PRESENTES; i++) {
                        const linkKey = `Presente_Link_${i}`;
                        const obsKey = `Presente_Obs_${i}`;
                        
                        // Garante que a linha existe e tem o link preenchido
                        if (row[linkKey]) {
                            presentes.push({
                                link: row[linkKey] || '',
                                obs: row[obsKey] || ''
                            });
                        }
                    }

                    acc[nome] = { presentes };
                    return acc;
                }, {});

                renderMainList();
            } catch (error) {
                console.error("Falha ao carregar dados:", error);
                alert('Erro ao carregar as listas de presente. Verifique a conex√£o e o URL da API.');
            } finally {
                hideLoading();
            }
        }
        
        async function saveData(dataToSave) {
            const nome = dataToSave.Nome;
            showLoading(`Salvando lista de ${nome}...`);
            
            // 1. Constr√≥i o objeto de dados que o SheetDB espera
            let sheetData = { Nome: nome };
            
            // Limpa todos os campos existentes antes de salvar os novos
            for (let i = 1; i <= MAX_PRESENTES; i++) {
                sheetData[`Presente_Link_${i}`] = '';
                sheetData[`Presente_Obs_${i}`] = '';
            }

            // Preenche os campos com os novos dados (limitado ao MAX_PRESENTES)
            dataToSave.presentes.slice(0, MAX_PRESENTES).forEach((p, i) => {
                sheetData[`Presente_Link_${i + 1}`] = p.link;
                sheetData[`Presente_Obs_${i + 1}`] = p.obs;
            });
            
            // 2. Tenta encontrar e editar a linha existente (usando o campo 'Nome' como chave de busca)
            const updateResponse = await fetch(`${SHEETDB_API_URL}/Nome/${encodeURIComponent(nome)}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: sheetData })
            });

            if (updateResponse.ok) {
                // Sucesso na edi√ß√£o
                dadosPresentes[nome] = { presentes: dataToSave.presentes };
                saveDataSuccess();
                return;
            }

            // 3. Se falhar na edi√ß√£o (linha n√£o encontrada), tenta adicionar uma nova linha
            const addResponse = await fetch(SHEETDB_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ data: sheetData })
            });
            
            if (addResponse.ok) {
                // Sucesso na adi√ß√£o
                dadosPresentes[nome] = { presentes: dataToSave.presentes };
                saveDataSuccess();
                return;
            }
            
            // 4. Falha geral
            alert('Erro ao salvar ou atualizar a lista. Tente novamente mais tarde.');
            hideLoading();
        }
        
        function saveDataSuccess() {
            alert('Lista de Desejos salva/atualizada com sucesso! Todos os familiares podem ver.');
            document.getElementById('cadastro-form-area').style.display = 'none';
            loadData(); // Recarrega a lista para mostrar as mudan√ßas
        }
        

        // --- Fun√ß√µes de UI (Mantidas) ---
        
        // 1. Renderiza a lista de nomes e status (em ordem alfab√©tica)
        function renderMainList() {
            const listContainer = document.getElementById('main-list');
            listContainer.innerHTML = '';
            
            NOMES.forEach(nome => {
                const lista = dadosPresentes[nome] || { presentes: [] };
                const hasList = lista.presentes.length > 0;
                const listItem = document.createElement('div');
                listItem.classList.add('name-list-item', 'list-group-item');
                
                let statusHtml = '';
                if (hasList) {
                    listItem.classList.add('has-list');
                    statusHtml = `<span class="badge bg-success float-end">Lista OK (${lista.presentes.length} op√ß√µes)</span>`;
                } else {
                    statusHtml = `<span class="badge bg-secondary float-end">Lista Vazia</span>`;
                }
                
                listItem.innerHTML = `<span class="fw-bold">${nome}</span> ${statusHtml}`;
                listItem.onclick = () => showPresentesModal(nome);
                listContainer.appendChild(listItem);
            });
            populateNameSelect(); // Garante que o select tamb√©m est√° atualizado
        }
        
        // 2. Preenche o SELECT de nomes (em ordem alfab√©tica)
        function populateNameSelect() {
            const select = document.getElementById('nomeSelect');
            select.innerHTML = '<option value="" disabled selected>Selecione seu nome para cadastrar/editar</option>'; 
            
            NOMES.forEach(nome => {
                const option = document.createElement('option');
                option.value = nome;
                option.textContent = nome;
                select.appendChild(option);
            });
            
            select.addEventListener('change', loadDataForEdit);
        }

        // 3. Preenche o Modal de Visualiza√ß√£o
        function showPresentesModal(nome) {
            const lista = dadosPresentes[nome] || { presentes: [] };
            const modalTitle = document.getElementById('presentesModalLabel');
            const modalPresentes = document.getElementById('modal-presentes');
            const modalElement = document.getElementById('presentesModal');
            const modal = new bootstrap.Modal(modalElement);

            modalTitle.textContent = `Lista de Desejos de ${nome}`;
            modalPresentes.innerHTML = '';

            if (lista.presentes.length === 0) {
                modalPresentes.innerHTML = '<div class="alert alert-warning">Esta pessoa ainda n√£o cadastrou nenhuma sugest√£o de presente.</div>';
                modal.show();
                return;
            }

            // A. Mostrar Sugest√µes de Presente
            lista.presentes.forEach((p, index) => {
                const card = document.createElement('div');
                card.classList.add('presente-card');
                
                const linkContent = isUrl(p.link) 
                    ? `<a href="${p.link}" target="_blank" class="text-primary text-decoration-underline">${p.link}</a>` 
                    : p.link.replace(/\n/g, '<br>');

                const obsContent = p.obs.replace(/\n/g, '<br>') || 'Nenhuma observa√ß√£o ou informa√ß√£o de tamanho.';

                card.innerHTML = `
                    <p class="mb-1"><strong>Op√ß√£o ${index + 1}:</strong></p>
                    <div class="mb-2 ms-3 pre-wrap">${linkContent}</div>
                    <p class="mb-0 small"><strong>Detalhes / Tamanhos:</strong> <span class="pre-wrap">${obsContent}</span></p>
                `;
                modalPresentes.appendChild(card);
            });
            
            modal.show();
        }
        
        // 4. Carrega os dados para edi√ß√£o
        function loadDataForEdit() {
            const nome = document.getElementById('nomeSelect').value;
            const lista = dadosPresentes[nome] || { presentes: [] };
            
            document.getElementById('presentes-container').innerHTML = ''; 
            
            if (lista.presentes.length > 0) {
                lista.presentes.forEach(p => addPresenteInput(p.link, p.obs));
            } else {
                addPresenteInput();
            }
        }
        
        // 5. Adiciona campos de presente dinamicamente
        function addPresenteInput(link = '', obs = '') {
            const container = document.getElementById('presentes-container');
            
            if (container.children.length >= MAX_PRESENTES) {
                alert(`Limite de ${MAX_PRESENTES} sugest√µes atingido.`);
                return;
            }

            presenteCount = container.children.length + 1;

            const item = document.createElement('div');
            item.classList.add('presente-item', 'border', 'p-3', 'rounded', 'mb-3', 'bg-light');
            
            item.innerHTML = `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="mb-0">Op√ß√£o ${presenteCount}</h6>
                    <button type="button" class="btn-close remove-presente-btn" aria-label="Close"></button>
                </div>
                <div class="mb-3">
                    <label class="form-label">Link da Coisa ou Descri√ß√£o (Obrigat√≥rio):</label>
                    <textarea class="form-control" rows="2" data-type="link" placeholder="Ex: Link da Amazon ou 'Perfume Kaiak Natura'" required>${link}</textarea>
                </div>
                <div class="mb-1">
                    <label class="form-label">Observa√ß√£o / Tamanhos (Sapato, Roupa, etc.):</label>
                    <textarea class="form-control" rows="3" data-type="obs" placeholder="Ex: Tamanho M, Sapato 38, Cor Azul. N√£o gosto de verde.">${obs}</textarea>
                </div>
            `;
            
            container.appendChild(item);
            
            const removeButton = item.querySelector('.remove-presente-btn');
            removeButton.addEventListener('click', () => {
                if (container.children.length > 1) {
                    item.remove();
                    updatePresenteNumbers();
                } else {
                    alert('Voc√™ deve ter pelo menos uma op√ß√£o de presente.');
                }
            });

            updatePresenteNumbers();
        }

        // 6. Atualiza a numera√ß√£o das op√ß√µes
        function updatePresenteNumbers() {
            const container = document.getElementById('presentes-container');
            const items = container.querySelectorAll('.presente-item');
            
            items.forEach((item, index) => {
                const number = index + 1;
                item.querySelector('h6').textContent = `Op√ß√£o ${number}`;
                
                const removeButton = item.querySelector('.remove-presente-btn');
                removeButton.disabled = items.length === 1;
            });
            
            // Controla o bot√£o de adicionar para respeitar o limite
            document.getElementById('add-presente-btn').disabled = items.length >= MAX_PRESENTES;
        }
        
        // 7. Envio do Formul√°rio (Chama a fun√ß√£o de salvar API)
        document.getElementById('presente-form').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const nome = document.getElementById('nomeSelect').value;
            
            const presentes = [];
            let valid = true;

            document.querySelectorAll('.presente-item').forEach(item => {
                const link = item.querySelector('textarea[data-type="link"]').value.trim();
                const obs = item.querySelector('textarea[data-type="obs"]').value.trim();
                
                if (link) { 
                    presentes.push({ link, obs });
                } else {
                    valid = false; 
                }
            });

            if (presentes.length === 0 || !valid) {
                alert('Por favor, preencha o campo "Link ou Descri√ß√£o" para todas as op√ß√µes de presente.');
                return;
            }

            // Chama a fun√ß√£o ass√≠ncrona para salvar via API
            saveData({ Nome: nome, presentes: presentes });
        });

        // 8. Utilidade: Checa se √© um URL
        function isUrl(string) {
            try {
                let tempUrl = string.trim();
                if (!tempUrl.startsWith('http')) {
                    tempUrl = 'http://' + tempUrl;
                }
                new URL(tempUrl);
                return true;
            } catch (e) {
                return false;
            }
        }
        
        // --- Inicializa√ß√£o ---
        document.addEventListener('DOMContentLoaded', () => {
            // Inicia o carregamento dos dados da API
            loadData();
            
            document.getElementById('add-presente-btn').addEventListener('click', () => addPresenteInput());
            
            document.getElementById('btn-toggle-cadastro').addEventListener('click', () => {
                const area = document.getElementById('cadastro-form-area');
                const isHidden = area.style.display === 'none' || area.style.display === '';

                if (isHidden) {
                    document.getElementById('nomeSelect').value = '';
                    document.getElementById('presente-form').reset();
                    document.getElementById('presentes-container').innerHTML = '';
                    addPresenteInput();
                    area.style.display = 'block';
                } else {
                    area.style.display = 'none';
                }
            });
        });
        
    </script>

</body>
</html>
